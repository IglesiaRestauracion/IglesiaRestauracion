<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador 11 Aniversario | Minimalista</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Montserrat:wght@300;400;500;700;800&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* PALETA C√ÅLIDA MINIMALISTA */
            --bg-cream: #ffffff;
            --accent-green: #008f39;
            --accent-orange: #ff8c00;
            --accent-gold: #ffb700;
            --text-dark: #222222;
            --text-gray: #555555;
            --border-light: #eaeaea;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 380px;
            background: white;
            padding: 25px;
            border-right: 1px solid #ddd;
            display: flex; flex-direction: column; gap: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.05); z-index: 100;
            overflow-y: auto;
        }

        .sidebar-header { border-bottom: 2px solid var(--accent-green); padding-bottom: 15px; margin-bottom: 5px; }
        .sidebar-header h2 { color: var(--accent-green); margin: 0; font-size: 1.2rem; font-weight: 800; text-transform: uppercase; }
        
        /* Inputs de archivo mejorados */
        .file-upload-zone {
            border: 2px dashed #ccc; border-radius: 8px; padding: 15px;
            text-align: center; cursor: pointer; transition: 0.3s;
            background: #fafafa; position: relative;
        }
        .file-upload-zone:hover { border-color: var(--accent-orange); background: #fff8e1; }
        .file-upload-zone i { font-size: 1.5rem; color: #888; margin-bottom: 5px; }
        .file-upload-zone p { font-size: 0.8rem; color: #555; margin: 0; font-weight: 600; }
        .file-upload-zone span { font-size: 0.7rem; color: #999; display: block; margin-top: 5px;}
        .file-success { border-color: var(--accent-green) !important; background: #e8f5e9 !important; }
        .file-success i { color: var(--accent-green) !important; }

        /* Tabs & Panels */
        .tabs { display: flex; gap: 5px; background: #eee; padding: 5px; border-radius: 8px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 5px; font-weight: 600; color: #666; transition: 0.3s; font-size: 0.85rem; }
        .tab-btn.active { background: white; color: var(--accent-orange); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .panel { display: none; margin-top: 15px; }
        .panel.active { display: block; }

        /* Contact List */
        .contacts-list { margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .contact-item { background: #fff; border: 1px solid #eee; padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .contact-info strong { display: block; font-size: 0.9rem; color: #333; }
        .btn-wa { width: 35px; height: 35px; border-radius: 50%; background: #25D366; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-wa:hover { transform: scale(1.1); box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
        .btn-wa.done { background: #ccc; cursor: default; transform: none; }

        .manual-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-family: 'Montserrat'; }
        .btn-gen { width: 100%; padding: 12px; background: var(--accent-orange); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .btn-gen:hover { background: #e67e00; }

        /* --- PREVIEW AREA --- */
        .preview-area {
            flex-grow: 1; background: #333; display: flex;
            justify-content: center; align-items: center; padding: 40px; overflow: auto;
            background-image: radial-gradient(#444 1px, transparent 1px); background-size: 20px 20px;
        }

        /* --- AFICHE (CANVAS) --- */
        #flyer {
            width: 650px;
            height: 950px; /* Alto A4 aprox */
            position: relative;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 0 60px rgba(0,0,0,0.5); flex-shrink: 0;
            background-color: var(--bg-cream);
            overflow: hidden;
        }

        /* Decoraci√≥n de Fondo (Sutil) */
        .bg-deco-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 10px;
            background: linear-gradient(90deg, var(--accent-green) 30%, var(--accent-gold) 30%, var(--accent-gold) 70%, var(--accent-green) 70%);
            z-index: 10;
        }
        .watermark-bg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 20rem; font-weight: 900; color: rgba(0,0,0,0.02);
            font-family: 'Titan One'; white-space: nowrap; pointer-events: none;
        }

        /* 1. HEADER ELEGANTE */
        .header-section {
            width: 100%; text-align: center; padding-top: 50px; padding-bottom: 20px;
        }
        .brand-title {
            color: var(--accent-green); font-weight: 800; font-size: 1.3rem; letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: 5px;
        }
        .brand-subtitle {
            color: var(--text-gray); font-size: 0.9rem; letter-spacing: 4px; text-transform: uppercase;
        }

        /* 2. LOGO CENTRAL */
        .logo-area {
            margin: 10px 0; width: 100%; min-height: 200px;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        .logo-svg {
            width: 90%; max-height: 260px; object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); /* Sombra suave */
        }
        .logo-alert {
            border: 2px dashed #ccc; padding: 30px; border-radius: 10px; color: #999; width: 80%;
        }

        /* 3. CONTENIDO CARTA */
        .content-body {
            flex-grow: 1; width: 85%;
            display: flex; flex-direction: column; align-items: center;
        }

        .main-message {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem; color: var(--accent-orange); font-weight: 700; font-style: italic;
            margin-bottom: 20px;
        }

        .greeting-text {
            color: var(--text-dark); font-size: 1rem; line-height: 1.6; text-align: center; margin-bottom: 20px;
        }
        .dynamic-name {
            color: var(--accent-green); font-weight: 800; font-size: 1.2rem; text-transform: uppercase;
            display: block; margin-top: 5px;
        }

        /* Grid de Invitados */
        .guests-container {
            width: 100%; margin-bottom: 20px;
            border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 15px 0;
        }
        .guests-title { text-align: center; font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        
        .guest-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
        .guest-row { display: flex; align-items: center; gap: 8px; }
        .guest-row i { color: var(--accent-gold); font-size: 0.8rem; }
        .guest-info { font-size: 0.8rem; color: #444; line-height: 1.2; }
        .guest-info strong { color: var(--text-dark); display: block; font-size: 0.85rem; }

        /* Fecha Highlight */
        .date-badge {
            background: linear-gradient(135deg, var(--accent-orange), #ff6b6b);
            color: white; padding: 10px 30px; border-radius: 50px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(255, 140, 0, 0.3);
            margin-bottom: 5px; font-size: 0.95rem;
        }
        .location-line { color: var(--text-gray); font-size: 0.85rem; font-weight: 500; margin-bottom: 20px;}

        /* FIRMA CENTRADA */
        .signature-wrapper {
            margin-top: auto; display: flex; flex-direction: column; align-items: center;
            margin-bottom: 30px; width: 280px; position: relative;
        }
        .sign-img { height: 70px; margin-bottom: -20px; position: relative; z-index: 2; }
        .pastor-line {
            border-top: 1px solid #ccc; width: 100%; padding-top: 5px;
            color: var(--text-dark); font-weight: 800; font-size: 0.85rem; text-transform: uppercase;
            text-align: center;
        }

        /* 4. FOOTER */
        .footer-strip {
            width: 100%; background: var(--accent-green); color: white;
            padding: 12px; text-align: center; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;
        }

        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; }
            #flyer { transform: scale(0.55); margin: -180px 0; }
        }
    </style>
</head>
<body>

    <!-- BARRA LATERAL -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Gestor 11 Aniversario</h2>
            <p>Dise√±o Minimalista & C√°lido</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('files')">1. Archivos</button>
            <button class="tab-btn" onclick="switchTab('list')">2. Excel</button>
            <button class="tab-btn" onclick="switchTab('manual')">3. Manual</button>
        </div>

        <!-- PANEL ARCHIVOS -->
        <div id="panel-files" class="panel active">
            <!-- Upload Logo -->
            <label class="file-upload-zone" id="zone-logo">
                <i class="fas fa-image"></i>
                <p>Cargar Logo "Ven a Cristo"</p>
                <span id="txt-logo">Obligatorio: logo2.svg</span>
                <input type="file" id="logoInput" accept=".svg, .png, .jpg">
            </label>

            <br>

            <!-- Upload Firma -->
            <label class="file-upload-zone" id="zone-sign">
                <i class="fas fa-signature"></i>
                <p>Cargar Firma Pastor</p>
                <span id="txt-sign">Formato PNG Transparente</span>
                <input type="file" id="signInput" accept=".png, .jpg">
            </label>
        </div>

        <!-- PANEL EXCEL -->
        <div id="panel-list" class="panel">
            <label class="file-upload-zone" style="border-color: var(--accent-green); background: #f1f8e9;">
                <i class="fas fa-file-excel" style="color: var(--accent-green);"></i>
                <p>Subir Excel (.xlsx)</p>
                <span>Columnas: Pastor, Iglesia, Celular</span>
                <input type="file" id="excelInput" accept=".xlsx, .xls">
            </label>
            <div class="contacts-list" id="contactsList">
                <div style="text-align: center; color: #999; padding: 20px;">Esperando archivo...</div>
            </div>
        </div>

        <!-- PANEL MANUAL -->
        <div id="panel-manual" class="panel">
            <input type="text" class="manual-input" id="man-pastor" placeholder="Nombre del Pastor" oninput="updateManual()">
            <input type="text" class="manual-input" id="man-iglesia" placeholder="Nombre de la Iglesia" oninput="updateManual()">
            <input type="text" class="manual-input" id="man-celular" placeholder="Celular (ej: 51999999999)">
            <button class="btn-gen" onclick="processManual(this)">Descargar y Enviar</button>
        </div>
    </div>

    <!-- PREVIEW CANVAS -->
    <div class="preview-area">
        <div id="flyer">
            <div class="bg-deco-top"></div>
            <div class="watermark-bg">11</div>

            <!-- HEADER -->
            <div class="header-section">
                <div class="brand-title">Centro de Restauraci√≥n</div>
                <div class="brand-subtitle">11 A√±os de Victoria</div>
            </div>

            <!-- LOGO (Carga manual obligatoria para descarga) -->
            <div class="logo-area">
                <img id="logo-img" class="logo-svg" style="display: none;">
                <div id="logo-alert" class="logo-alert">
                    <i class="fas fa-arrow-left"></i> Por favor, carga el archivo <b>logo2.svg</b> en el panel izquierdo.
                </div>
            </div>

            <!-- CUERPO -->
            <div class="content-body">
                <div class="main-message">"Ven tal como est√°s"</div>
                
                <div class="greeting-text">
                    Apreciado Pastor y Congregaci√≥n
                    <span class="dynamic-name" id="prev-pastor">NOMBRE DEL PASTOR</span>
                    <span style="font-size: 0.9rem; color: #666; display:block; margin-top:3px;" id="prev-iglesia">Nombre Iglesia</span>
                </div>

                <!-- INVITADOS -->
                <div class="guests-container">
                    <div class="guests-title">Invitados Especiales</div>
                    <div class="guest-grid">
                        <div class="guest-row">
                            <i class="fas fa-user-tie"></i>
                            <div class="guest-info"><strong>Ps. Eugenio Masias</strong>Ecuador üá™üá®</div>
                        </div>
                        <div class="guest-row">
                            <i class="fas fa-user-tie"></i>
                            <div class="guest-info"><strong>Abel Zapata</strong>Chile üá®üá±</div>
                        </div>
                        <div class="guest-row">
                            <i class="fas fa-user-tie"></i>
                            <div class="guest-info"><strong>Ruben Dias</strong>Cerro de Pasco</div>
                        </div>
                        <div class="guest-row">
                            <i class="fas fa-fire"></i>
                            <div class="guest-info"><strong>Ps. Fernando √ëaupari</strong>Testimonio</div>
                        </div>
                    </div>
                </div>

                <!-- INFO -->
                <div class="date-badge">Del 22 al 25 de Enero ‚Ä¢ 7:00 PM</div>
                <div class="location-line">Mz. H Lote 23, Urb. Ciudad del Chofer</div>

                <!-- FIRMA -->
                <div class="signature-wrapper">
                    <img id="sign-img" class="sign-img" style="display: none;">
                    <div id="sign-placeholder" style="font-size:0.7rem; color:#ccc; margin-bottom:10px;">(Firma Digital)</div>
                    <div class="pastor-line">Brigadiel Cerna Ravines</div>
                    <div style="font-size: 0.75rem; color: #666; text-transform: uppercase;">Pastor Principal</div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="footer-strip">
                Chiclayo - Lambayeque - Per√∫
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- NAVEGACI√ìN ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            if(tabId === 'files') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('panel-files').classList.add('active');
            } else if(tabId === 'list') {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('panel-list').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[2].classList.add('active');
                document.getElementById('panel-manual').classList.add('active');
            }
        }

        // --- MANEJO DE IM√ÅGENES (FIX DEFINITIVO) ---
        function setupImageUpload(inputId, imgId, placeholderId, zoneId, textId) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        const img = document.getElementById(imgId);
                        img.src = evt.target.result; // Base64 DATA URL
                        img.style.display = 'block';
                        
                        if(placeholderId) document.getElementById(placeholderId).style.display = 'none';
                        
                        // Feedback visual en el bot√≥n
                        const zone = document.getElementById(zoneId);
                        zone.classList.add('file-success');
                        document.getElementById(textId).innerText = "Cargado: " + file.name;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        setupImageUpload('logoInput', 'logo-img', 'logo-alert', 'zone-logo', 'txt-logo');
        setupImageUpload('signInput', 'sign-img', 'sign-placeholder', 'zone-sign', 'txt-sign');

        // --- MANEJO DE EXCEL ---
        let contactsData = [];
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                contactsData = XLSX.utils.sheet_to_json(sheet);
                renderList();
            };
            reader.readAsArrayBuffer(file);
        });

        function renderList() {
            const list = document.getElementById('contactsList');
            list.innerHTML = '';
            contactsData.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.innerHTML = `
                    <div class="contact-info">
                        <strong>${c.Pastor || 'Pastor'}</strong>
                        <span>${c.Iglesia || ''}</span>
                    </div>
                    <button class="btn-wa" onclick="process(${i}, this)"><i class="fab fa-whatsapp"></i></button>
                `;
                list.appendChild(div);
            });
        }

        // --- PROCESAMIENTO Y ENV√çO ---
        function updateManual() {
            document.getElementById('prev-pastor').innerText = document.getElementById('man-pastor').value || "NOMBRE DEL PASTOR";
            document.getElementById('prev-iglesia').innerText = document.getElementById('man-iglesia').value || "Nombre Iglesia";
        }

        async function process(index, btn) {
            const data = contactsData[index];
            await generate(data.Pastor || "", data.Iglesia || "", data.Celular, btn);
        }

        async function processManual(btn) {
            const p = document.getElementById('man-pastor').value;
            const i = document.getElementById('man-iglesia').value;
            const c = document.getElementById('man-celular').value;
            if(!p) return alert("Ingrese nombre");
            await generate(p, i, c, btn);
        }

        async function generate(pastor, iglesia, celular, btnElement) {
            const originalIcon = btnElement.innerHTML;
            btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // 1. Actualizar textos
            document.getElementById('prev-pastor').innerText = pastor;
            document.getElementById('prev-iglesia').innerText = iglesia;

            // 2. Esperar renderizado del navegador
            await new Promise(r => setTimeout(r, 600));

            const flyer = document.getElementById('flyer');
            
            try {
                // 3. Captura con html2canvas
                const canvas = await html2canvas(flyer, {
                    scale: 2, // Alta calidad
                    backgroundColor: "#ffffff", // Fondo blanco para transparencia
                    useCORS: true, // Permitir im√°genes externas si las hubiera
                    allowTaint: true
                });

                // 4. Descargar
                const link = document.createElement('a');
                link.download = `Invitacion_11Aniv_${pastor.replace(/[^a-zA-Z0-9]/g,'')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                // 5. Abrir WhatsApp
                if(celular) {
                    const msg = `¬°Bendiciones Pastor ${pastor}! üéâ\n\nLa Iglesia Centro de Restauraci√≥n le invita a nuestra Gran Campa√±a de 11 Aniversario "VEN A CRISTO".\n\nüìÖ Fecha: Del 22 al 25 de Enero\nüìç Lugar: Ciudad del Chofer\n\nAdjunto su invitaci√≥n personalizada. ¬°Le esperamos!`;
                    
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    const url = isMobile 
                        ? `https://api.whatsapp.com/send?phone=${celular}&text=${encodeURIComponent(msg)}`
                        : `https://web.whatsapp.com/send?phone=${celular}&text=${encodeURIComponent(msg)}`;
                    
                    window.open(url, '_blank');
                }

                if(btnElement.classList.contains('btn-wa')) {
                    btnElement.className = 'btn-wa done';
                    btnElement.innerHTML = '<i class="fas fa-check"></i>';
                    btnElement.disabled = true;
                } else {
                    btnElement.innerHTML = "Listo";
                    setTimeout(() => btnElement.innerHTML = "Descargar y Enviar", 3000);
                }

            } catch (e) {
                console.error(e);
                alert("Error al generar imagen");
                btnElement.innerHTML = originalIcon;
            }
        }
    </script>
</body>
</html>
